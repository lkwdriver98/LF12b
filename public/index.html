<!doctype html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TechFlair – Projektportal</title>
  <meta name="description" content="TechFlair – MicroK8s-Projektportal mit Login-Gate. Landing für Besucher, Inhalte nach Anmeldung." />
  <link rel="icon" href="assets/techflair-favicon.png" type="image/png" />
  <style>
    :root{--bg:#0a0f1c;--fg:#e6edf3;--muted:#9fb1c3;--primary:#0ea5e9;--primary-2:#6366f1;--primary-contrast:#ffffff;--surface:#0f172a;--border:#1f2a3a;--shadow:0 14px 32px rgba(0,0,0,.55);--radius:1rem}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--fg);line-height:1.65}
    a{color:var(--primary);text-decoration:none} a:hover{text-decoration:underline}
    .container{width:min(1200px,92%);margin:0 auto} .hidden{display:none!important}
    header{position:sticky;top:0;background:rgba(10,15,28,.8);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);box-shadow:var(--shadow);z-index:50}
    .nav{display:flex;justify-content:space-between;align-items:center;padding:1rem 0}
    .brand{display:flex;align-items:center;gap:.75rem;font-weight:800;font-size:1.1rem;letter-spacing:.2px}
    .brand__logo-img{height:60px;object-fit:contain;border-radius:12px;padding:6px;box-shadow:inset 0 2px 6px rgba(255,255,255,0.1), inset 0 -2px 6px rgba(0,0,0,0.6), 0 4px 12px rgba(0,0,0,0.4);backdrop-filter:blur(4px)}
    .nav__links{display:flex;gap:1.1rem;align-items:center}
    .nav__links a{color:var(--muted);font-weight:600} .nav__links a:hover{color:var(--primary)}
    .btn{padding:.6rem 1rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--fg);cursor:pointer;font-weight:600;box-shadow:var(--shadow)}
    .btn--primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:var(--primary-contrast);border:0}
    .hero{padding:5rem 0 3.2rem} .hero__grid{display:grid;grid-template-columns:1.2fr .8fr;gap:2rem;align-items:center}
    .hero__badge{display:inline-block;background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;padding:.3rem .8rem;border-radius:999px;font-size:.85rem;margin-bottom:1rem}
    .hero__card{background:linear-gradient(180deg,rgba(14,165,233,.06),rgba(99,102,241,.06)),var(--surface);border:1px solid var(--border);padding:1.5rem;border-radius:var(--radius);box-shadow:var(--shadow)}
    section{padding:3rem 0} .section__title{font-size:2rem;font-weight:800;margin:0 0 1rem} .section__lead{color:var(--muted);margin:0 0 2rem}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem} .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
    .card{background:var(--surface);border:1px solid var(--border);padding:1.2rem;border-radius:var(--radius);box-shadow:var(--shadow)}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:.8rem;overflow:hidden}
    th,td{padding:.7rem .9rem;border-bottom:1px solid var(--border);text-align:left;font-size:.95rem}
    thead th{background:rgba(14,165,233,.08);font-weight:700}
    tbody tr:last-child td{border-bottom:0}
    footer{padding:2.2rem 0;border-top:1px solid var(--border);text-align:center;color:var(--muted)}
    .modal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.55);backdrop-filter:blur(6px);z-index:100}
    .modal__panel{width:min(520px,92%);background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1.25rem}
    .tabs{display:flex;gap:.5rem;margin-bottom:.75rem}.tab{flex:1;padding:.55rem;text-align:center;border:1px solid var(--border);border-radius:.6rem;cursor:pointer}.tab[aria-selected="true"]{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:var(--primary-contrast)}
    .grid{display:grid;gap:.7rem}.row{display:grid;gap:.3rem}
    .gate{display:grid;place-items:center;text-align:center;padding:4rem 0}
    .gate h1{font-size:clamp(2rem,4vw,3rem);margin:.5rem 0 1rem}
    .gate p{color:var(--muted);max-width:720px;margin:0 auto 1.2rem}
    @media (max-width:980px){.hero__grid{grid-template-columns:1fr}} @media (max-width:640px){.nav__links{display:none}.grid-3,.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <!-- ACHTUNG: Lege die Datei unter app/public/assets/techflair-logo.png -->
        <img class="brand__logo-img" src="assets/techflair-logo.png" alt="TechFlair Logo" />
        <span>TechFlair</span>
      </div>
      <nav class="nav__links">
        <a href="#home">Start</a>
        <a href="#project" data-gated class="hidden">Projekt</a>
        <a href="#deliverables" data-gated class="hidden">Deliverables</a>
        <a href="#kontakt">Kontakt</a>
        <a href="#admin" data-role="admin" class="hidden">Admin</a>
      </nav>
      <div style="display:flex;gap:.6rem;align-items:center">
        <button id="loginBtn" class="btn">Anmelden</button>
        <button id="logoutBtn" class="btn hidden">Abmelden</button>
        <a class="btn btn--primary" href="#kontakt">Anfrage</a>
      </div>
    </div>
  </header>

  <main>
    <!-- START/LANDING (immer sichtbar) -->
    <section class="container gate" id="home">
      <span class="hero__badge">Willkommen bei TechFlair</span>
      <h1>Projektportal – MicroK8s-Cluster & Webanwendung</h1>
      <p>Hier findest du alle projektrelevanten Inhalte. Um die Details zu sehen (Architektur, Skripte, Downloads und Admin-Bereich), melde dich bitte an.</p>
      <div style="display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap">
        <button class="btn btn--primary" id="ctaLogin">Jetzt anmelden</button>
        <button class="btn" id="ctaRegister">Konto erstellen</button>
      </div>
    </section>

    <!-- PROJEKT (nur nach Login sichtbar) -->
    <section class="hero hidden" id="project" data-gated>
      <div class="container hero__grid">
        <div>
          <span class="hero__badge">Nach Anmeldung sichtbar</span>
          <h2>Projekt: MicroK8s-Cluster mit Webanwendung</h2>
          <p class="section__lead">Ziele, Architektur und Umsetzung: Container, Ingress, Monitoring, Automatisierung.</p>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap">
            <a class="btn btn--primary" href="#deliverables">Zum Projekt-Ordner</a>
            <a class="btn" href="#kontakt">Kontakt</a>
          </div>
        </div>
        <div class="hero__card">
          <strong>Kurzüberblick</strong>
          <ul style="margin:.6rem 0 0 1.2rem">
            <li>Deployment (2 Replikas), Service, Ingress</li>
            <li>Automatisierte Bootstrap-Skripte</li>
            <li>Basis-Monitoring & Health-Checks</li>
            <li>Dokumentation & Präsentation</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- DELIVERABLES (nur nach Login sichtbar) -->
    <section class="container hidden" id="deliverables" data-gated>
      <h2 class="section__title">Deliverables (Projekt-Ordner)</h2>
      <div class="grid-2">
        <div class="card">
          <h3>Downloads</h3>
          <ul>
            <li><a href="/project/scripts/bootstrap.sh" download>scripts/bootstrap.sh</a></li>
            <li><a href="/project/k8s/deploy-nginx.yaml" download>k8s/deploy-nginx.yaml</a></li>
            <li><a href="/project/k8s/service.yaml" download>k8s/service.yaml</a></li>
            <li><a href="/project/k8s/ingress.yaml" download>k8s/ingress.yaml</a></li>
          </ul>
          <p style="color:#9fb1c3">Dateien unter <code>app/public/project/…</code> ablegen.</p>
        </div>
        <div class="card">
          <h3>Struktur</h3>
<pre><code>app/
├─ server.js
├─ package.json
├─ public/
│  ├─ index.html
│  ├─ assets/ (Logo, Bilder, CSS)
│  └─ project/ (scripts + k8s)
└─ data/ (SQLite – demo)
</code></pre>
        </div>
      </div>
    </section>

    <!-- KONTAKT (immer sichtbar) -->
    <section class="container" id="kontakt">
      <h2 class="section__title">Kontakt</h2>
      <form id="contactForm" class="grid" novalidate>
        <div class="row"><label for="name">Name</label><input id="name" name="name" required></div>
        <div class="row"><label for="email">E-Mail</label><input id="email" name="email" type="email" required></div>
        <div class="row"><label for="message">Nachricht</label><textarea id="message" name="message" rows="4" required></textarea></div>
        <div style="display:flex;gap:.6rem;align-items:center">
          <button class="btn btn--primary" type="submit">Absenden</button>
          <span id="formStatus" aria-live="polite"></span>
        </div>
      </form>
    </section>

    <!-- ADMIN (nur für admin) -->
    <section class="container hidden" id="admin" aria-labelledby="admin-title" data-role="admin">
      <h2 id="admin-title" class="section__title">Admin-Dashboard</h2>
      <div class="card" style="margin-bottom:1rem">
        <div style="display:flex;gap:.6rem;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div>Verwaltung der Benutzerkonten</div>
          <div style="display:flex;gap:.6rem">
            <button id="refreshUsers" class="btn">Aktualisieren</button>
            <button id="exportCsv" class="btn">CSV exportieren</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div style="overflow:auto">
          <table id="usersTable" aria-label="Benutzer">
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>E-Mail</th><th>Rolle</th><th>Erstellt</th><th>Aktion</th>
              </tr>
            </thead>
            <tbody id="usersTbody">
              <tr><td colspan="6">Noch keine Daten…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">© <span id="year"></span> – TechFlair. Auth by Express + SQLite + JWT.</div>
  </footer>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="modal__panel">
      <div class="tabs" role="tablist">
        <button id="tabLogin" class="tab" role="tab" aria-selected="true">Anmelden</button>
        <button id="tabRegister" class="tab" role="tab" aria-selected="false">Registrieren</button>
      </div>
      <form id="loginForm" class="grid" autocomplete="on">
        <div class="row"><label for="loginEmail">E-Mail</label><input id="loginEmail" type="email" required></div>
        <div class="row"><label for="loginPassword">Passwort</label><input id="loginPassword" type="password" required></div>
        <div style="display:flex;gap:.6rem;justify-content:flex-end">
          <button class="btn" type="button" id="switchToRegister">Neu hier?</button>
          <button class="btn btn--primary" type="submit">Login</button>
        </div>
        <p id="loginStatus" aria-live="polite"></p>
      </form>
      <form id="registerForm" class="grid hidden" autocomplete="on">
        <div class="row"><label for="regName">Name</label><input id="regName" type="text" required></div>
        <div class="row"><label for="regEmail">E-Mail</label><input id="regEmail" type="email" required></div>
        <div class="row"><label for="regPassword">Passwort</label><input id="regPassword" type="password" required></div>
        <div class="row"><label for="regKey">Admin-Schlüssel (optional)</label><input id="regKey" type="text" placeholder="TECHFLAIR-ADMIN"></div>
        <div style="display:flex;gap:.6rem;justify-content:flex-end">
          <button class="btn" type="button" id="switchToLogin">Schon ein Konto?</button>
          <button class="btn btn--primary" type="submit">Registrieren</button>
        </div>
        <p id="registerStatus" aria-live="polite"></p>
      </form>
      <div style="display:flex;justify-content:flex-end;margin-top:.5rem">
        <button id="authClose" class="btn">Schließen</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}
    function $(s){return document.querySelector(s)} function $all(s){return document.querySelectorAll(s)}
    function init(){
      const TOKEN_KEY='tf_token';
      const loginBtn=$('#loginBtn'), logoutBtn=$('#logoutBtn');
      const modal=$('#authModal'), closeBtn=$('#authClose');
      const tabLogin=$('#tabLogin'), tabRegister=$('#tabRegister');
      const loginForm=$('#loginForm'), registerForm=$('#registerForm');
      const loginStatus=$('#loginStatus'), registerStatus=$('#registerStatus');

      // Landing-CTAs
      $('#ctaLogin')?.addEventListener('click',()=>{open();showLogin()});
      $('#ctaRegister')?.addEventListener('click',()=>{open();showRegister()});

      function token(){ return localStorage.getItem(TOKEN_KEY) }
      async function me(){
        if(!token()) return null;
        try{
          const r = await fetch('/api/me',{headers:{'Authorization':'Bearer '+token()}});
          if(!r.ok) return null;
          const data = await r.json(); return data.user;
        }catch{ return null; }
      }
      function setGate(isLogged, isAdmin){
        // alles mit [data-gated] nur für eingeloggte User
        $all('[data-gated]').forEach(el=>el.classList.toggle('hidden', !isLogged));
        // Admin-only
        $all('[data-role="admin"]').forEach(el=>el.classList.toggle('hidden', !isAdmin));
      }
      function applyRole(user){
        const isLogged=!!user; const isAdmin=isLogged && user.role==='admin';
        loginBtn.classList.toggle('hidden', isLogged);
        logoutBtn.classList.toggle('hidden', !isLogged);
        setGate(isLogged, isAdmin);
        if(isAdmin){ loadUsers(); }
      }
      async function refresh(){ applyRole(await me()) }

      function open(){modal.classList.remove('hidden')} function close(){modal.classList.add('hidden')}
      function showLogin(){tabLogin.setAttribute('aria-selected','true');tabRegister.setAttribute('aria-selected','false');loginForm.classList.remove('hidden');registerForm.classList.add('hidden')}
      function showRegister(){tabLogin.setAttribute('aria-selected','false');tabRegister.setAttribute('aria-selected','true');loginForm.classList.add('hidden');registerForm.classList.remove('hidden')}

      loginBtn.onclick=()=>{open();showLogin()}
      logoutBtn.onclick=()=>{localStorage.removeItem(TOKEN_KEY); refresh()}
      closeBtn.onclick=close
      $('#switchToRegister').addEventListener('click',()=>showRegister())
      $('#switchToLogin').addEventListener('click',()=>showLogin())
      modal.addEventListener('click',e=>{if(e.target===modal)close()})
      tabLogin.addEventListener('click',showLogin)
      tabRegister.addEventListener('click',showRegister)

      // Login
      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); loginStatus.textContent='';
        const email=$('#loginEmail').value.trim(); const password=$('#loginPassword').value;
        try{
          const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
          const data=await r.json();
          if(!r.ok) throw new Error(data.error||'Login fehlgeschlagen');
          localStorage.setItem(TOKEN_KEY, data.token);
          close(); refresh();
        }catch(err){ loginStatus.textContent = err.message; }
      });

      // Register
      registerForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); registerStatus.textContent='';
        const name=$('#regName').value.trim(); const email=$('#regEmail').value.trim(); const password=$('#regPassword').value; const adminKey=$('#regKey').value.trim();
        try{
          const r=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,password,adminKey})});
          const data=await r.json();
          if(!r.ok) throw new Error(data.error||'Registrierung fehlgeschlagen');
          localStorage.setItem(TOKEN_KEY, data.token);
          close(); refresh();
        }catch(err){ registerStatus.textContent = err.message; }
      });

      // Kontakt (Demo)
      const form=$('#contactForm'), statusEl=$('#formStatus');
      form?.addEventListener('submit', e=>{
        e.preventDefault(); const d=new FormData(form);
        if(!d.get('name')||!d.get('email')||!d.get('message')){ statusEl.textContent='Bitte alle Felder ausfüllen.'; return; }
        form.reset(); statusEl.textContent='Danke! Wir melden uns zeitnah.';
      });

      // ---- Admin ----
      $('#refreshUsers')?.addEventListener('click', loadUsers);
      $('#exportCsv')?.addEventListener('click', exportCsv);

      async function loadUsers(){
        const tbody = $('#usersTbody'); if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6">Lade…</td></tr>';
        const tok = token(); if(!tok){ tbody.innerHTML='<tr><td colspan="6">Nicht angemeldet.</td></tr>'; return; }
        try{
          const r = await fetch('/api/users',{headers:{Authorization:'Bearer '+tok}});
          if(!r.ok) throw new Error('Keine Berechtigung oder Fehler.');
          const data = await r.json();
          if(!data.users?.length){ tbody.innerHTML='<tr><td colspan="6">Keine Benutzer vorhanden.</td></tr>'; return; }
          tbody.innerHTML = data.users.map(u => `
            <tr>
              <td>${u.id}</td>
              <td>${escapeHtml(u.name)}</td>
              <td>${escapeHtml(u.email)}</td>
              <td>${u.role}</td>
              <td>${new Date(u.created_at).toLocaleString()}</td>
              <td><button class="btn" data-del="${u.id}">Löschen</button></td>
            </tr>
          `).join('');
          tbody.querySelectorAll('button[data-del]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-del');
              if(!confirm('Benutzer wirklich löschen?')) return;
              const r = await fetch('/api/users/'+id, {method:'DELETE', headers:{Authorization:'Bearer '+token()}});
              if(!r.ok){ alert('Löschen fehlgeschlagen'); return; }
              loadUsers();
            });
          });
        }catch(e){
          tbody.innerHTML = `<tr><td colspan="6">${e.message}</td></tr>`;
        }
      }

      function exportCsv(){
        const body = document.querySelector('#usersTbody'); if(!body) return;
        const rows = [['ID','Name','Email','Rolle','Erstellt']];
        body.querySelectorAll('tr').forEach(tr=>{
          const tds=[...tr.querySelectorAll('td')].map(td=>td.innerText);
          if (tds.length>=5 && tds[0] !== 'Lade…' && !tds[0].includes('Keine Benutzer')) rows.push(tds.slice(0,5));
        });
        const csv = rows.map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(';')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `users_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a); a.click(); a.remove();
      }

      function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
      $('#year').textContent=new Date().getFullYear();
      refresh();
    }
  })();
  </script>
</body>
</html>
